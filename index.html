<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TMスタッツ Pro 最終版（画像出力修正版）</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>

body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
    background:#f3f4f6;
    margin:0;
    padding:8px;
}

.card{
    background:#fff;
    padding:12px;
    border-radius:12px;
    margin-bottom:10px;
}

.player-list{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:6px;
    max-height:220px;
    overflow:auto;
}

.timer{
    color:#2563eb;
    font-weight:bold;
    margin-left:6px;
}

.counter{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:4px;
}

.counter button{
    width:32px;
    height:32px;
    border:none;
    border-radius:6px;
    background:#e2e8f0;
}

.value{
    width:30px;
    text-align:center;
}

button{
    width:100%;
    padding:8px;
    border:none;
    border-radius:8px;
    margin-top:6px;
}

.primary{background:#2563eb;color:#fff;}
.success{background:#16a34a;color:#fff;}

</style>
</head>

<body>

<h2>TMスタッツ Pro（画像出力修正版）</h2>

<div class="card">

<label>日にち</label>
<input type="date" id="matchDate">

<label>対戦相手</label>
<input type="text" id="opponent">

<label>フォーメーション</label>
<input type="text" id="formation">

</div>

<div class="card">

<div>入力タイプ</div>

<label><input type="radio" name="mode" value="attack"> 攻撃</label>
<label><input type="radio" name="mode" value="defense"> 守備</label>
<label><input type="radio" name="mode" value="both"> 攻撃守備両方</label>

</div>

<div class="card">

<div>選手選択</div>
<div class="player-list" id="playerList"></div>

<button class="primary" onclick="startInput()">入力開始</button>
<button class="success" onclick="finishMatch()">試合終了</button>

</div>

<div id="inputArea"></div>

<button class="success" onclick="exportExcel()">Excel出力</button>
<button class="primary" onclick="exportImage()">画像出力</button>
<button class="primary" onclick="clearAllData()">全クリア</button>

<script>

/* ===== データ ===== */

const players=[
"2 りょう","3 はるみち","4 いっさ","5 はるや","6 だいち","7 ひなた",
"8 りく","9 あつと","10 だいき","11 とうり","13 しゅうせい",
"14 けいすけ","17 ゆうだい","18 しょう","19 しゅん","20 こう",
"22 にへこう","23 たもん","24 はたこう","25 けいま","26 とうま",
"27 そうしろう","28 しょうま","29 たいしん","30 ゆう",
"35 あやと","36 はる","37 かい","38 あらた","39 はると"
];

const attackKeys=["CHA","SHO","HD_O","THP","LP"];
const defenseKeys=["SZ","PO","HD_D","SL"];

const labels={
CHA:"【攻撃】ドリブルチャレンジ",
SHO:"【攻撃】シュート",
HD_O:"【攻撃】ヘディング",
THP:"【攻撃】スルーパス",
LP:"【攻撃】ロングパス",
SZ:"【守備】ボール完全奪取",
PO:"【守備】抜かれた数",
HD_D:"【守備】ヘディングクリア",
SL:"【守備】スライディング"
};

let records={};
let playerState={};
let currentMode="";
let timerInterval=null;

/* UI生成 */

const playerList=document.getElementById("playerList");

players.forEach(p=>{

    const label=document.createElement("label");

    const check=document.createElement("input");
    check.type="checkbox";
    check.value=p;
    check.onchange=syncPlayerTimer;

    label.appendChild(check);
    label.append(" "+p);

    const span=document.createElement("span");
    span.id="timer_"+p.replace(" ","_");
    span.className="timer";
    span.innerText="00:00";

    label.appendChild(span);

    playerList.appendChild(label);

    playerState[p]={active:false,time:0};

    records[p]={};
    [...attackKeys,...defenseKeys].forEach(k=>records[p][k]=0);
});

/* 入力開始 */

function startInput(){

    const mode=document.querySelector("input[name='mode']:checked");

    if(!mode){
        alert("入力タイプ選択");
        return;
    }

    currentMode=mode.value;

    syncPlayerTimer();

    if(!timerInterval){
        timerInterval=setInterval(()=>{

            Object.keys(playerState).forEach(name=>{
                if(playerState[name].active){
                    playerState[name].time++;
                    updateTimerUI(name);
                }
            });

        },1000);
    }

    renderCounters();
}

/* チェック同期 */

function syncPlayerTimer(){

    document.querySelectorAll("#playerList input").forEach(el=>{
        playerState[el.value].active=el.checked;
    });
}

/* カウンタ表示 */

function renderCounters(){

    inputArea.innerHTML="";

    const checked=[...document.querySelectorAll("#playerList input:checked")];

    const showAttack=currentMode==="attack"||currentMode==="both";
    const showDefense=currentMode==="defense"||currentMode==="both";

    checked.forEach(c=>{

        const name=c.value;

        const card=document.createElement("div");
        card.className="card";

        card.innerHTML=`<b>${name}</b>`;

        if(showAttack){
            attackKeys.forEach(k=>{
                card.innerHTML+=counterHTML(name,k);
            });
        }

        if(showDefense){
            defenseKeys.forEach(k=>{
                card.innerHTML+=counterHTML(name,k);
            });
        }

        inputArea.appendChild(card);
    });
}

function counterHTML(name,key){
    return `
    <div class="counter">
        <div style="flex:1">${labels[key]}</div>
        <button onclick="change('${name}','${key}',-1)">-</button>
        <div class="value" id="${name}_${key}">
        ${records[name][key]}
        </div>
        <button onclick="change('${name}','${key}',1)">+</button>
    </div>`;
}

/* カウント */

function change(player,key,delta){

    records[player][key]+=delta;

    if(records[player][key]<0)
        records[player][key]=0;

    document.getElementById(`${player}_${key}`)
        .innerText=records[player][key];
}

/* タイマーUI */

function updateTimerUI(name){

    const sec=playerState[name].time;

    const m=Math.floor(sec/60);
    const s=sec%60;

    document.getElementById(
        "timer_"+name.replace(" ","_")
    ).innerText=
        String(m).padStart(2,"0")+":"+
        String(s).padStart(2,"0");
}

/* 試合終了 */

function finishMatch(){

    if(timerInterval){
        clearInterval(timerInterval);
        timerInterval=null;
    }

    Object.keys(playerState).forEach(name=>{
        playerState[name].active=false;
    });
}

/* ===== Excel出力 ===== */

function exportExcel(){

    const exportPlayers=Object.keys(playerState)
        .filter(name=>playerState[name].time>=1);

    if(!exportPlayers.length){
        alert("出場時間1秒以上の選手がいません");
        return;
    }

    const rows=[];

    exportPlayers.forEach(player=>{

        const r=records[player];
        const parts=player.split(" ");

        const sec=playerState[player].time;
        const m=Math.floor(sec/60);
        const s=sec%60;

        rows.push({
            対戦相手:opponent.value||"",
            日にち:matchDate.value||"",
            フォーメーション:formation.value||"",
            攻守:currentMode,
            選手NO:parts[0],
            選手名:parts[1],
            出場時間:`${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`,
            CHA:r.CHA||0,
            SHO:r.SHO||0,
            HD_O:r.HD_O||0,
            THP:r.THP||0,
            LP:r.LP||0,
            SZ:r.SZ||0,
            PO:r.PO||0,
            HD_D:r.HD_D||0,
            SL:r.SL||0
        });
    });

    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.json_to_sheet(rows);

    XLSX.utils.book_append_sheet(wb,ws,"TM");

    XLSX.writeFile(
        wb,
        (matchDate.value||"match").replaceAll("-","")+"_TM.xlsx"
    );
}

/* ===== 画像出力（完全実装） ===== */

function exportImage(){

    const exportPlayers=Object.keys(playerState)
        .filter(name=>playerState[name].time>=1);

    if(!exportPlayers.length){
        alert("出場時間1秒以上の選手がいません");
        return;
    }

    const canvas=document.createElement("canvas");
    canvas.width=900;
    canvas.height=1500;

    const ctx=canvas.getContext("2d");

    ctx.fillStyle="#ffffff";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    ctx.fillStyle="#000000";
    ctx.font="20px sans-serif";

    let y=40;

    ctx.fillText("TMスタッツ結果",40,y); y+=40;

    exportPlayers.forEach(player=>{

        const r=records[player];
        const parts=player.split(" ");

        const sec=playerState[player].time;
        const m=Math.floor(sec/60);
        const s=sec%60;

        ctx.fillText(`■ ${parts[0]} ${parts[1]}`,40,y);
        y+=30;

        ctx.fillText(`出場時間 ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`,60,y);
        y+=30;

        Object.keys(labels).forEach(k=>{
            ctx.fillText(
                labels[k]+":"+(r[k]||0),
                60,y
            );
            y+=25;
        });

        y+=20;
    });

    const link=document.createElement("a");
    link.download="TM_stats.png";
    link.href=canvas.toDataURL("image/png");

    link.click();
}

/* 全クリア */

function clearAllData(){

    if(!confirm("全データをクリアしますか？")) return;

    Object.keys(records).forEach(p=>{
        [...attackKeys,...defenseKeys].forEach(k=>{
            records[p][k]=0;
        });
    });

    Object.values(playerState).forEach(st=>{
        st.time=0;
        st.active=false;
    });

    document.querySelectorAll(".value").forEach(el=>{
        el.innerText="0";
    });

    document.querySelectorAll(".timer").forEach(el=>{
        el.innerText="00:00";
    });

    document.querySelectorAll("#playerList input")
    .forEach(el=>el.checked=false);
}

</script>

</body>
</html>
