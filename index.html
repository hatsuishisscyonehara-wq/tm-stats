<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TMスタッツ入力 Pro</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>

body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
    background:#f3f4f6;
    margin:0;
    padding:8px;
}

h2{
    text-align:center;
    margin:8px 0;
}

.card{
    background:#fff;
    padding:10px;
    border-radius:12px;
    margin-bottom:8px;
    box-shadow:0 3px 8px rgba(0,0,0,0.08);
}

.player-list{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:4px;
    max-height:200px;
    overflow:auto;
    font-size:14px;
}

.counter{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:4px;
}

.counter-name{flex:1;font-size:13px;}

.counter button{
    width:30px;
    height:30px;
    border:none;
    border-radius:6px;
    background:#e2e8f0;
    font-size:15px;
}

.value{
    width:28px;
    text-align:center;
}

.section-title{
    font-weight:bold;
    margin-top:6px;
    margin-bottom:3px;
}

button{
    width:100%;
    padding:8px;
    border:none;
    border-radius:8px;
    margin-top:6px;
    font-size:14px;
}

.primary{background:#2563eb;color:#fff;}
.success{background:#16a34a;color:#fff;}

.terms{
    margin:6px 0 8px 0;
    font-size:12px;
    background:#eef2f7;
    padding:8px;
    border-radius:8px;
    line-height:1.5;
}

/* toast */

#toast{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    background:black;
    color:white;
    padding:10px 16px;
    border-radius:20px;
    opacity:0;
    transition:.3s;
    z-index:999;
}

#toast.show{
    opacity:.85;
}

</style>
</head>

<body>

<h2>TMスタッツ入力 Pro</h2>

<div class="card">

<label>日にち</label>
<input type="date" id="matchDate">

<label>対戦相手</label>
<input type="text" id="opponent">

<label>フォーメーション</label>
<select id="formation">
<option value="">選択してください</option>
<option>4-2-1</option>
<option>3-3-2</option>
<option>3-3-1</option>
<option>2-3-2</option>
</select>

<div class="section-title">入力タイプ</div>
<label><input type="radio" name="mode" value="attack"> 攻撃</label>
<label><input type="radio" name="mode" value="defense"> 守備</label>

<div class="section-title">選手選択</div>
<div class="player-list" id="playerList"></div>

<button class="primary" onclick="startInput()">入力開始</button>

</div>

<div id="termsArea"></div>
<div id="inputArea"></div>

<button class="success" onclick="exportExcel()">Excel出力</button>

<div id="toast"></div>

<script>

/* ===== データ ===== */

const players=[
"2 りょう","3 はるみち","4 いっさ","5 はるや","6 だいち","7 ひなた",
"8 りく","9 あつと","10 だいき","11 とうり","13 しゅうせい",
"14 けいすけ","17 ゆうだい","18 しょう","19 しゅん","20 こう",
"22 にへこう","23 たもん","24 はたこう","25 けいま","26 とうま",
"27 そうしろう","28 しょうま","29 たいしん","30 ゆう",
"35 あやと","36 はる","37 かい","38 あらた","39 はると"
];

const attackKeys=["CHA","SHO","HD_O","THP","LP"];
const defenseKeys=["SZ","PO","HD_D","SL"];

const labels={
CHA:"ドリブル",
SHO:"シュート",
HD_O:"ヘディング",
THP:"スルーパス",
LP:"ロングパス",
SZ:"奪取",
PO:"抜かれ",
HD_D:"HDクリア",
SL:"スライディング"
};

let records={};
let currentMode="";

/* ===== UI生成 ===== */

const playerList=document.getElementById("playerList");

players.forEach(p=>{
    const label=document.createElement("label");
    const check=document.createElement("input");
    check.type="checkbox";
    check.value=p;

    label.appendChild(check);
    label.append(" "+p);

    playerList.appendChild(label);
});

/* ===== トースト ===== */

function toast(msg){
    const t=document.getElementById("toast");
    t.innerText=msg;
    t.classList.add("show");

    setTimeout(()=>{
        t.classList.remove("show");
    },1500);
}

/* ===== 自動保存 ===== */

function saveLocal(){
    localStorage.setItem("tm_records",JSON.stringify(records));
    localStorage.setItem("tm_matchDate",matchDate.value);
    localStorage.setItem("tm_opponent",opponent.value);
    localStorage.setItem("tm_formation",formation.value);
}

/* ===== 復元 ===== */

window.onload=function(){

    const r=localStorage.getItem("tm_records");
    if(r) records=JSON.parse(r);

    matchDate.value=localStorage.getItem("tm_matchDate")||"";
    opponent.value=localStorage.getItem("tm_opponent")||"";
    formation.value=localStorage.getItem("tm_formation")||"";
};

/* ===== 入力開始 ===== */

function startInput(){

    let errors=[];
    if(!matchDate.value) errors.push("日にち");
    if(!opponent.value) errors.push("対戦相手");
    if(!formation.value) errors.push("フォーメーション");

    const mode=document.querySelector("input[name='mode']:checked");
    if(!mode) errors.push("攻守選択");

    const checked=[...document.querySelectorAll("#playerList input:checked")];

    if(checked.length===0) errors.push("選手選択");

    if(errors.length){
        alert("入力してください\n・"+errors.join("\n・"));
        return;
    }

    currentMode=mode.value;

    inputArea.innerHTML="";
    termsArea.innerHTML="";

    const keys = currentMode==="attack" ? attackKeys : defenseKeys;

    checked.forEach(c=>{

        const name=c.value;

        if(!records[name]){
            records[name]={};
            [...attackKeys,...defenseKeys].forEach(k=>records[name][k]=0);
        }

        const card=document.createElement("div");
        card.className="card";

        card.innerHTML=`<div class="section-title">${name}</div>`;

        keys.forEach(k=>{
            card.innerHTML+=`
            <div class="counter">
                <div style="flex:1">${labels[k]}</div>
                <button onclick="change('${name}','${k}',-1)">-</button>
                <div class="value" id="${name}_${k}">
                ${records[name][k]||0}
                </div>
                <button onclick="change('${name}','${k}',1)">+</button>
            </div>`;
        });

        inputArea.appendChild(card);
    });
}

/* ===== カウンター ===== */

function change(player,key,delta){

    records[player][key]+=delta;

    if(records[player][key]<0)
        records[player][key]=0;

    document.getElementById(`${player}_${key}`)
        .innerText=records[player][key];

    saveLocal();
}

/* ===== Excel出力 ===== */

function exportExcel(){

    if(!Object.keys(records).length){
        alert("データなし");
        return;
    }

    const rows=[];

    Object.keys(records).forEach(player=>{
        const r=records[player];
        const parts=player.split(" ");

        rows.push({
            対戦相手:opponent.value,
            日にち:matchDate.value,
            フォーメーション:formation.value,
            攻守:currentMode==="attack"?"攻撃":"守備",
            NO:parts[0],
            名前:parts[1],
            CHA:r.CHA||0,
            SHO:r.SHO||0,
            HD_O:r.HD_O||0,
            THP:r.THP||0,
            LP:r.LP||0,
            SZ:r.SZ||0,
            PO:r.PO||0,
            HD_D:r.HD_D||0,
            SL:r.SL||0
        });
    });

    const wb=XLSX.utils.book_new();
    const ws=XLSX.utils.json_to_sheet(rows);

    XLSX.utils.book_append_sheet(wb,ws,"TM");

    XLSX.writeFile(
        wb,
        `${matchDate.value.replaceAll("-","")}_TM_${opponent.value}.xlsx`
    );

    toast("Excel出力しました");
}

</script>

</body>
</html>
